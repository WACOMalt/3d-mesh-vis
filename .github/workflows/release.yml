permissions:
  contents: write
  packages: write

on:
  push:
    tags:
      - 'v*'
  release:
    types: [published]
  workflow_dispatch:

jobs:
  create-release:
    # Skip if release already exists (triggered by 'release' event)
    if: github.event_name == 'push'
    runs-on: self-hosted
    outputs:
      release_id: ${{ steps.create_release.outputs.id }}
      release_upload_url: ${{ steps.create_release.outputs.upload_url }}
    steps:
      - uses: actions/checkout@v4
      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          name: Release ${{ github.ref_name }}
          draft: false
          prerelease: false
          generate_release_notes: true

  build-web:
    # Run if Push event OR (Release event AND NOT Local Build)
    # Use always() to run even if create-release was skipped (e.g. valid release event)
    if: always() && (needs.create-release.result == 'success' || needs.create-release.result == 'skipped') && (github.event_name == 'push' || !contains(github.event.release.body, '[Local Build]'))
    needs: create-release
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Build Web Artifact
        run: |
          chmod +x build-web.sh
          ./build-web.sh
      - name: Upload Web Artifact
        uses: softprops/action-gh-release@v1
        with:
          # Use release from event payload if available, else from create-release job
          tag_name: ${{ github.event.release.tag_name || github.ref_name }}
          files: build/web/web-release.zip

  deploy-pages:
    needs: build-web
    if: always() && needs.build-web.result == 'success'
    runs-on: self-hosted
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          commit_message: "deploy: ${{ github.ref_name }}"

  build-tauri-mac:
    # ALWAYS run Mac build
    needs: create-release
    if: always() && (needs.create-release.result == 'success' || needs.create-release.result == 'skipped')
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Install Rust Stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: 'aarch64-apple-darwin,x86_64-apple-darwin'
      - name: install frontend dependencies
        run: npm install
      - uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          args: '--target universal-apple-darwin'
      - name: Upload Mac Artifacts
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.release.tag_name || github.ref_name }}
          files: |
            src-tauri/target/universal-apple-darwin/release/bundle/dmg/*.dmg

  build-tauri-linux-arm:
    # Dedicated job for Linux ARM64 using QEMU emulation
    # Reverted to Cloud Runner due to Docker-in-Docker volume mapping issues on self-hosted
    needs: create-release
    if: always() && (needs.create-release.result == 'success' || needs.create-release.result == 'skipped') && (github.event_name == 'push' || !contains(github.event.release.body, '[Local Build]'))
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build Linux ARM64
        uses: uraimo/run-on-arch-action@v2
        id: build
        with:
          arch: aarch64
          distro: ubuntu22.04
          githubToken: ${{ secrets.GITHUB_TOKEN }}
          install: |
            apt-get update
            apt-get install -y curl wget file libssl-dev libgtk-3-dev libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf libsoup-3.0-dev libjavascriptcoregtk-4.1-dev build-essential libfuse2
            curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
            curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
            apt-get install -y nodejs
          run: |
            export CARGO_BUILD_JOBS=1
            # Create 4GB swap file to prevent QEMU OOM crashes
            sudo fallocate -l 4G /swapfile
            sudo chmod 600 /swapfile
            sudo mkswap /swapfile
            sudo swapon /swapfile
            
            source $HOME/.cargo/env
            npm install
            npm run tauri build
      - name: Upload Release Artifacts
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.release.tag_name || github.ref_name }}
          files: |
            src-tauri/target/release/bundle/appimage/*.AppImage
            src-tauri/target/release/bundle/deb/*.deb

  build-tauri-others:
    # Run only for Cloud Builds (NOT Local Build)
    needs: create-release
    if: always() && (needs.create-release.result == 'success' || needs.create-release.result == 'skipped') && (github.event_name == 'push' || !contains(github.event.release.body, '[Local Build]'))
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: 'self-hosted'
            args: ''
            target: ''
            files: |
              src-tauri/target/release/bundle/appimage/*.AppImage
              src-tauri/target/release/bundle/deb/*.deb
          # Linux ARM64 (Experimental)
          # - platform: 'ubuntu-22.04'
          #   args: '--target aarch64-unknown-linux-gnu'
          #   target: 'aarch64-unknown-linux-gnu'
          #   files: |
          #     src-tauri/target/aarch64-unknown-linux-gnu/release/bundle/appimage/*.AppImage
          #     src-tauri/target/aarch64-unknown-linux-gnu/release/bundle/deb/*.deb
          
          # Windows x64
          - platform: 'windows-latest'
            args: ''
            target: ''
            files: |
              src-tauri/target/release/bundle/nsis/*.exe
              src-tauri/target/release/bundle/msi/*.msi
          # Windows ARM64
          - platform: 'windows-latest'
            args: '--target aarch64-pc-windows-msvc'
            target: 'aarch64-pc-windows-msvc'
            files: |
              src-tauri/target/aarch64-pc-windows-msvc/release/bundle/nsis/*.exe
              src-tauri/target/aarch64-pc-windows-msvc/release/bundle/msi/*.msi

    runs-on: ${{ matrix.platform }}
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Install Rust Stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
      - name: install dependencies (ubuntu only)
        if: matrix.platform == 'ubuntu-22.04' || matrix.platform == 'self-hosted'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf libsoup-3.0-dev libjavascriptcoregtk-4.1-dev
      - name: install frontend dependencies
        run: npm install
      - uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          args: ${{ matrix.args }}
      - name: Upload Release Artifacts
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.release.tag_name || github.ref_name }}
          files: ${{ matrix.files }}

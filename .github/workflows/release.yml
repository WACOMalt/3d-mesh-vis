name: Release Build
permissions:
  contents: write

on:
  push:
    tags:
      - 'v*'
  release:
    types: [published]
  workflow_dispatch:

jobs:
  create-release:
    # Skip if release already exists (triggered by 'release' event)
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    outputs:
      release_id: ${{ steps.create_release.outputs.id }}
      release_upload_url: ${{ steps.create_release.outputs.upload_url }}
    steps:
      - uses: actions/checkout@v4
      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          name: Release ${{ github.ref_name }}
          draft: false
          prerelease: false
          generate_release_notes: true

  build-web:
    # Run if Push event OR (Release event AND NOT Local Build)
    # Use always() to run even if create-release was skipped (e.g. valid release event)
    if: always() && (needs.create-release.result == 'success' || needs.create-release.result == 'skipped') && (github.event_name == 'push' || !contains(github.event.release.body, '[Local Build]'))
    needs: create-release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Build Web Artifact
        run: |
          chmod +x build-web.sh
          ./build-web.sh
      - name: Upload Web Artifact
        uses: softprops/action-gh-release@v1
        with:
          # Use release from event payload if available, else from create-release job
          tag_name: ${{ github.event.release.tag_name || github.ref_name }}
          files: build/web/web-release.zip

  deploy-pages:
    needs: build-web
    if: always() && needs.build-web.result == 'success'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          commit_message: "deploy: ${{ github.ref_name }}"

  build-tauri-mac:
    # ALWAYS run Mac build
    needs: create-release
    if: always() && (needs.create-release.result == 'success' || needs.create-release.result == 'skipped')
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Install Rust Stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: 'aarch64-apple-darwin,x86_64-apple-darwin'
      - name: install frontend dependencies
        run: npm install
      - uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          args: '--target aarch64-apple-darwin'
      - name: Upload Mac Artifacts
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.release.tag_name || github.ref_name }}
          files: |
            src-tauri/target/aarch64-apple-darwin/release/bundle/dmg/*.dmg

  build-tauri-others:
    # Run only for Cloud Builds (NOT Local Build)
    needs: create-release
    if: always() && (needs.create-release.result == 'success' || needs.create-release.result == 'skipped') && (github.event_name == 'push' || !contains(github.event.release.body, '[Local Build]'))
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: 'ubuntu-22.04'
            args: ''
            files: |
              src-tauri/target/release/bundle/appimage/*.AppImage
              src-tauri/target/release/bundle/deb/*.deb
          - platform: 'windows-latest'
            args: ''
            files: |
              src-tauri/target/release/bundle/nsis/*.exe
              src-tauri/target/release/bundle/msi/*.msi
    runs-on: ${{ matrix.platform }}
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Install Rust Stable
        uses: dtolnay/rust-toolchain@stable
      - name: install dependencies (ubuntu only)
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf libsoup-3.0-dev libjavascriptcoregtk-4.1-dev
      - name: install frontend dependencies
        run: npm install
      - uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          args: ${{ matrix.args }}
      - name: Upload Release Artifacts
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.release.tag_name || github.ref_name }}
          files: ${{ matrix.files }}
